name: Publish Daily Article

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:  # Allow manual triggers

jobs:
  publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon0 \
            libgbm1 \
            libasound2 \
            libxrandr2 \
            libpango-1.0-0 \
            libcairo2 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libcups2
      
      - name: Publish Article
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          MEDIUM_INTEGRATION_TOKEN: ${{ secrets.MEDIUM_INTEGRATION_TOKEN }}
          MEDIUM_USERNAME: ${{ secrets.MEDIUM_USERNAME }}
          MEDIUM_PASSWORD: ${{ secrets.MEDIUM_PASSWORD }}
          AFFILIATE_API_KEY: ${{ secrets.AFFILIATE_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: node src/orchestrator.js
      
      - name: Commit state changes
        run: |
          git config user.name "blogt-bot"
          git config user.email "bot@blogt.automation"
          git add state.yaml logs/
          git diff --staged --quiet || git commit -m "chore: auto-publish $(date -u +%Y-%m-%d)"
          git push
        continue-on-error: false
      
      - name: Notify Slack on Failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: node src/utils/slack-notifier.js
      
      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: execution-logs
          path: logs/
          retention-days: 30
